<!DOCTYPE HTML>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="author" content="Gaëtan Renaudeau" />
    <meta name="description" content="" />
    <meta name="keywords" content="animation,canvas,javascript,bezier,gamedev,css,sass,playframework,transition,linux,html,mobile,library,navigation,sysadmin,templating,math,websocket,blender,color,GLSL,WebGL,audio,iteratee,hackday,float,reactive,unix,AWOP,promise,Q,MIDI,zound,fm,WebRTC,js13k,functional,rendering,ludumdare,js1k,phaser,webgl,react,vdom,gl-react,opengl,relay," />

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@greweb">
    <meta name="twitter:title" content="Universal GL Effects for Web and Native">
    
    <meta name="twitter:creator" content="@greweb">
    

    <title>@GreWeb - Universal GL Effects for Web and Native</title>
    <link href='http://fonts.googleapis.com/css?family=Fredericka+the+Great|Arapey|Roboto:400,700,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/style/main.css" />
    <link rel='shortcut icon' href='/favicon.png' />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://greweb.me/rss/index.xml" />
  </head>
  <body>

    <header role="banner">
      <h1><a href="http://greweb.me">@GreWeb</a></h1>
      <h2></h2>
      <nav>
        <a href="mailto:renaudeau.gaetan@gmail.com">Mail</a>
        <a href="http://github.com/gre" target="_blank">Github</a>
        <a href="http://twitter.com/greweb" target="_blank">Twitter</a>
        <a href="http://www.linkedin.com/pub/gaetan-renaudeau/21/258/620" target="_blank">LinkedIn</a>
        <a href="https://soundcloud.com/greweb" target="_blank">SoundCloud</a>
      </nav>
    </header>

    <div id="container">
    <div id="main">
      <div id="content">
        <article>
  
  
  <header>
    <h1><a href="/2016/06/glreactconf/">Universal GL Effects for Web and Native</a></h1>
    <time class="date" datetime="2016-06-19">June 19, 2016</time>
   <span class="tags">
     <a class="tag" href="/tag/react.html">react</a>
     <a class="tag" href="/tag/webgl.html">webgl</a>
     <a class="tag" href="/tag/gl-react.html">gl-react</a>
     
   </span>
  </header>

  <div class="entry-content">
    <script src="http://localhost:35729/"></script>

<p>Last February, I talked about <a href="https://github.com/projectseptemberinc/gl-react"><code>gl-react</code></a> at React.js conference.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/Xnqy_zkBAew" frameborder="0" allowfullscreen></iframe>

<blockquote>
<p><a href="https://www.youtube.com/playlist?list=PLb0IAmt7-GS0M8Q95RIc2lOM6nc77q1IY">Checkout talks</a> of this conference if you are interested by React subject.
I want to thanks the incredible team behind React.js for the awesome conference and giving me the opportunity to come to San Francisco.</p>
</blockquote>

<p><em>This article will cover some more technical detail of <a href="https://github.com/projectseptemberinc/gl-react"><code>gl-react</code></a> that wasn&#39;t explained in the talk.</em></p>

<blockquote>
<p><em>Also, I&#39;ll try to not go TOO MUCH into technical detail neither, because it would take weeks to cover gl-react features and its implementation tricks!</em></p>
</blockquote>

<!--more-->

<hr>

<p>We have developed, at <a href="http://projectseptember.com">Project September</a>, an <a href="https://medium.com/@mjackson/universal-javascript-4761051b7ae9">universal</a> OpenGL wrapper for React called <a href="https://github.com/projectseptemberinc/gl-react"><code>gl-react</code></a> working with 2 other libraries: <a href="https://github.com/projectseptemberinc/gl-react-dom"><code>gl-react-dom</code></a> (wraps WebGL) and <a href="https://github.com/projectseptemberinc/gl-react-native"><code>gl-react-native</code></a> (wraps OpenGL).</p>

<p>The library allows to define <strong>advanced effects</strong> on top of <strong>images, videos, texts or any other VDOM Content</strong> (like UI Views).</p>

<p>Checkout the following <code>gl-react</code> demos running with the <strong>same codebase across iOS, Android and the Web !!!</strong></p>

<h2><a href="http://projectseptemberinc.github.io/gl-react-dom/Examples/AdvancedEffects/"><strong>AdvancedEffects</strong></a></h2>

<p><img src="/images/2016/03/advanced-effects.gif" style="width:100%" /></p>

<h2><a href="https://github.com/gre/gl-react-image-effects"><strong>github.com/gre/gl-react-image-effects</strong></a></h2>

<p><a href="http://greweb.me/gl-react-image-effects/" style="text-align:center"><img src="/images/2016/03/image-effects-ios.gif" style="width: 33%;" /><img src="/images/2016/03/image-effects-web.png" style="width: 33%;" /><img src="/images/2016/03/image-effects-android.png" style="width: 33%" /></a></p>

<h2>Adopting React paradigm</h2>

<p>There are a few important points in React that <code>gl-react</code> follows to fit its paradigm.</p>

<h3>1. React is about composition</h3>

<p><strong>Components are first class citizen</strong> in React.
A Component provides isolation by exposing a simple API (props) and encapsulates internal lifecycle.
One particular prop is the <code>children</code> prop that, by convention, allows to pass-in children components to a component.</p>

<p>For instance, we can define a component called <code>Container</code> taking a <code>children</code> prop and use it like this in JSX:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Container&gt;</span>
  <span class="nt">&lt;div&gt;</span>Hello<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/Container&gt;</span>
</code></pre></div>
<blockquote>
<p>Note that &quot;JSX&quot; is a syntax sugar that, in this example, transpiles to something like:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">Container</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">children</span><span class="o">:</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">children</span><span class="o">:</span> <span class="s2">&quot;Hello&quot;</span> <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>There are really no magic here: JSX just tends to be more convenient to write and, most of the time, it would be more annoying to use createElement API.</p>
</blockquote>

<h3>2. React is about Functional Programming...</h3>

<p>This might not be that obvious at a first glance but React is about FP. In React paradigm, you describe the full rendering of your application <em>(in &quot;Virtual DOM&quot;)</em> for a given application state, and you do this every time something changes in the application. So fundamentally, you just have to implement that <strong>function from State to Virtual DOM</strong> to implement your web application – <em>which is close to render loops in game dev (but it&#39;s another subject^^).</em></p>

<h3>...and reconciliation on top of an underlying Imperative API</h3>

<p>In React, you don&#39;t go mutating the DOM but you just RENDER EVERYTHING everytime! It&#39;s very simple to reason about, it removes lot of inconsistency bugs and React is here to optimize this with <a href="https://facebook.github.io/react/docs/reconciliation.html">an algorithm called &quot;reconciliation&quot;</a> (or diff/patch).</p>

<blockquote>
<p>Efficiently translating an high level immutable API into a lower level mutable API is the hard work that solves React on top of DOM, as well does gl-react on top of OpenGL.</p>
</blockquote>

<p>The <a href="https://facebook.github.io/react/docs/reconciliation.html">reconciliation</a> work done by React is a complex optimization problem that have trade-offs. This work is all about <strong>translating a imperative API (the DOM) to a functional API (React VDOM)</strong>.</p>

<p>In <a href="https://github.com/projectseptemberinc/gl-react"><code>gl-react</code></a>, we have the <strong>exact same problem to resolve</strong>: <a href="https://github.com/projectseptemberinc/gl-react"><code>gl-react</code></a> exposes a <strong>functional API</strong> and implements for you the complex work over the mutable, stateful and low-level API that is OpenGL / WebGL.</p>

<h3>3. React is a thin wrapper</h3>

<p>One other key point of React is that it&#39;s a <strong>thin wrapper on top of DOM</strong>. React focus on translating <strong>imperative API =&gt; functional API</strong> with the most minimal &amp; generic way, meaning that React won&#39;t hide you what the DOM elements are about <em>(same as React Native tries just to be on top of real Native components)</em>.</p>

<p>We tried to follow this principle as well when wrapping (Open/Web)<strong>GL</strong>:
we want to hide the complex and imperative part of GL but just expose the great functional parts that are the <strong>Fragment Shaders</strong> and the <strong>Framebuffers</strong>.</p>

<h2>Hardcoding the vertex part of the pipeline</h2>

<p><img src="/images/2016/03/hardcoded_pipeline.png" alt=""></p>

<p><code>gl-react</code> <em>currently</em> focuses on what can be achieved with <strong>composing Fragment Shaders</strong> with multiple <strong>Framebuffers</strong> that define a <strong>graph of effects</strong>. The Vertex Data &amp; Vertex Shaders are currently hardcoded.</p>

<blockquote>
<p><code>gl-react</code> might unlock this hardcoded part in the future – <a href="https://twitter.com/snikhilesh/status/707730742994833408">some recent experiments by @snikhilesh</a> shows a promising overview of what can possibility by done there!</p>
</blockquote>

<p>But for now, we focus on the huge challenge to implement <code>gl-react</code> seamlessly between the Web, Android and iOS implementations and to work on performance <em>(e.g of the content rasterization performance)</em>.</p>

<blockquote class="twitter-tweet" data-lang="fr"><p lang="en" dir="ltr">Notes from <a href="https://twitter.com/greweb">@greweb</a>&#39;s <a href="https://twitter.com/hashtag/reactjsconf?src=hash">#reactjsconf</a> talk Universal GL Effects for Web and Native <a href="https://t.co/JnIOjAQCOK">pic.twitter.com/JnIOjAQCOK</a></p>&mdash; Michael Chan (@chantastic) <a href="https://twitter.com/chantastic/status/702213897520943104">23 février 2016</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2><em>&quot;Functional Rendering&quot;</em></h2>

<p>We mentioned earlier that <code>gl-react</code> focuses on one important piece of OpenGL that is the fragment shader.</p>

<p><strong>A Fragment Shader is a function</strong> that independently colors each pixel:</p>

<p><img src="/images/2016/03/functional_rendering.png" alt=""></p>

<p><a href="http://greweb.me/2013/11/functional-rendering/">Watch this talk</a> for more detail on what I call <em>Functional Rendering</em>.</p>

<blockquote>
<p>Fragment shaders use a language called GLSL for <em>OpenGL Shading Language</em>. GLSL is a DSL dedicated to the functional rendering paradigm with &quot;graphics-ready&quot; types (vectors, matrix, sampler2D for textures) and built-in functions (like mix, distance, pow, cos,...).
Checkout the <a href="https://www.khronos.org/registry/gles/specs/2.0/GLSL_ES_Specification_1.0.17.pdf">specification</a>.</p>
</blockquote>

<h2>GL<em>uing</em> with React</h2>

<p><strong><a href="https://github.com/projectseptemberinc/gl-react"><code>gl-react</code></a> is a core library</strong>: it doesn&#39;t provide any built-in effects, users have to provide the shaders to render. Hopefully it&#39;s fairly simple to implement basic effects <em>(like saturation, contrast, brightness, inverse, hue,...)</em> in GLSL language and <em>Functional Rendering</em> paradigm.</p>

<h3>HelloGL example</h3>

<p>Let&#39;s create HelloGL, our first fragment shader:</p>
<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="k">precision</span> <span class="k">highp</span> <span class="k">float</span><span class="p">;</span>
<span class="k">varying</span> <span class="k">vec2</span> <span class="n">uv</span><span class="p">;</span> <span class="c1">// This variable vary in all pixel position (normalized from vec2(0.0,0.0) to vec2(1.0,1.0))</span>
<span class="k">void</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span> <span class="c1">// This function is called FOR EACH PIXEL</span>
  <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> <span class="c1">// red vary over X, green vary over Y, blue is 50%, alpha is 100%.</span>
<span class="p">}</span>
</code></pre></div>
<p>It&#39;s a <em>Point to Color</em> function:</p>

<ul>
<li><strong>the input comes from <code>varying vec2 uv</code></strong></li>
<li><strong>the output is set in <code>vec4</code> <code>gl_FragColor</code></strong> – <code>main()</code> is called for each pixel with a different <code>uv</code> (it&#39;s <em>varying</em> like the keyword indicates).</li>
</ul>

<p>so this HelloGL glsl code basically do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">[</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="p">]</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>
</code></pre></div>
<ul>
<li>The <strong>RED</strong> component increases with the X position of the pixel.</li>
<li>The <strong>GREEN</strong> component increases with the Y position of the pixel.</li>
</ul>

<p>which renders this nice 2D gradient:</p>

<p><img width="160" src="/images/2016/03/hellogl.png" /></p>

<p>Now, in <code>gl-react</code>, we can define &quot;HelloGL&quot; as a GL Component with:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">GL</span> <span class="nx">from</span> <span class="s2">&quot;gl-react&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">shaders</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">Shaders</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">helloGL</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">frag</span><span class="o">:</span> <span class="err">`</span>
<span class="nx">precision</span> <span class="nx">highp</span> <span class="kr">float</span><span class="p">;</span>
<span class="nx">varying</span> <span class="nx">vec2</span> <span class="nx">uv</span><span class="p">;</span>
<span class="k">void</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">gl_FragColor</span> <span class="o">=</span> <span class="nx">vec4</span><span class="p">(</span><span class="nx">uv</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">uv</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
<span class="p">}</span><span class="err">`</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="kr">const</span> <span class="nx">HelloGL</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">(</span>
  <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">GL</span><span class="p">.</span><span class="nx">Node</span> <span class="nx">shader</span><span class="o">=</span><span class="p">{</span><span class="nx">shaders</span><span class="p">.</span><span class="nx">helloGL</span><span class="p">}</span> <span class="o">/&gt;</span>
<span class="p">);</span>
</code></pre></div>
<p>and then use it:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;HelloGL</span> <span class="nt">/&gt;</span>
</code></pre></div>
<h3>ColoredDisc example</h3>

<p>GL Component can have props in parameter that can be passed-in as GLSL Uniforms.</p>

<p><img class="thumbnail-right" src="/images/2016/03/colored-disc.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;ColoredDisc</span>
  <span class="na">fromColor=</span><span class="s">{[</span> <span class="na">1</span><span class="err">,</span> <span class="na">0</span><span class="err">,</span> <span class="na">1</span> <span class="err">]}</span>
  <span class="na">toColor=</span><span class="s">{[</span> <span class="na">1</span><span class="err">,</span> <span class="na">1</span><span class="err">,</span> <span class="na">0</span> <span class="err">]}</span>
<span class="nt">/&gt;</span>
</code></pre></div>
<p><br /></p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">GL</span> <span class="nx">from</span> <span class="s2">&quot;gl-react&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">shaders</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">Shaders</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">ColoredDisc</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">frag</span><span class="o">:</span> <span class="err">`</span>
<span class="nx">precision</span> <span class="nx">highp</span> <span class="kr">float</span><span class="p">;</span>
<span class="nx">varying</span> <span class="nx">vec2</span> <span class="nx">uv</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">vec3</span> <span class="nx">fromColor</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">vec3</span> <span class="nx">toColor</span><span class="p">;</span>
<span class="k">void</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">float</span> <span class="nx">d</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">uv</span><span class="p">,</span> <span class="nx">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
  <span class="nx">gl_FragColor</span> <span class="o">=</span> <span class="nx">mix</span><span class="p">(</span>
    <span class="nx">vec4</span><span class="p">(</span><span class="nx">mix</span><span class="p">(</span><span class="nx">fromColor</span><span class="p">,</span> <span class="nx">toColor</span><span class="p">,</span> <span class="nx">d</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="nx">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
    <span class="nx">step</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span><span class="err">`</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="kr">const</span> <span class="nx">ColoredDisc</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">fromColor</span><span class="p">,</span> <span class="nx">toColor</span> <span class="p">})</span> <span class="o">=&gt;</span>
  <span class="o">&lt;</span><span class="nx">GL</span><span class="p">.</span><span class="nx">Node</span>
    <span class="nx">shader</span><span class="o">=</span><span class="p">{</span><span class="nx">shaders</span><span class="p">.</span><span class="nx">ColoredDisc</span><span class="p">}</span>
    <span class="nx">uniforms</span><span class="o">=</span><span class="p">{</span> <span class="p">{</span> <span class="nx">fromColor</span><span class="p">,</span> <span class="nx">toColor</span> <span class="p">}</span> <span class="p">}</span>
  <span class="o">/&gt;</span>
<span class="p">);</span>
</code></pre></div>
<h3>DiamondCrop example</h3>

<p><img class="thumbnail-right" src="/images/2016/03/diamond-crop.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;DiamondCrop&gt;</span>
  http://i.imgur.com/rkiglmm.jpg
<span class="nt">&lt;/DiamondCrop&gt;</span>
</code></pre></div>
<p><br /></p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">GL</span> <span class="nx">from</span> <span class="s2">&quot;gl-react&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">shaders</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">Shaders</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="nx">DiamondCrop</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">frag</span><span class="o">:</span> <span class="err">`</span>
<span class="nx">precision</span> <span class="nx">highp</span> <span class="kr">float</span><span class="p">;</span>
<span class="nx">varying</span> <span class="nx">vec2</span> <span class="nx">uv</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">sampler2D</span> <span class="nx">t</span><span class="p">;</span>
<span class="k">void</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">gl_FragColor</span> <span class="o">=</span> <span class="nx">mix</span><span class="p">(</span>
    <span class="nx">texture2D</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">uv</span><span class="p">),</span>
    <span class="nx">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
    <span class="nx">step</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">uv</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">uv</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
  <span class="p">);</span>
<span class="p">}</span><span class="err">`</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="kr">const</span> <span class="nx">DiamondCrop</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">children</span><span class="o">:</span> <span class="nx">t</span> <span class="p">})</span> <span class="o">=&gt;</span>
  <span class="o">&lt;</span><span class="nx">GL</span><span class="p">.</span><span class="nx">Node</span>
    <span class="nx">shader</span><span class="o">=</span><span class="p">{</span><span class="nx">shaders</span><span class="p">.</span><span class="nx">DiamondCrop</span><span class="p">}</span>
    <span class="nx">uniforms</span><span class="o">=</span><span class="p">{</span> <span class="p">{</span> <span class="nx">t</span> <span class="p">}</span> <span class="p">}</span>
  <span class="o">/&gt;</span>
<span class="p">);</span>
</code></pre></div>
<h2>Any content can be used</h2>

<p>Let&#39;s say we define a Blur effect with <code>gl-react</code>.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">Blur</span> <span class="o">=</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">(({</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">factor</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">...);</span>
</code></pre></div>
<p>Here, we have just defined a GL Component <code>Blur</code> that accept a children as a props.
It also accept a factor prop to define the intensity of that blur.
Therefore we can use <code>Blur</code> using JSX in many ways.</p>

<blockquote>
<p><strong>N.B.</strong> If you want such a Blur, checkout <a href="https://github.com/gre/gl-react-blur">gl-react-blur</a>.</p>
</blockquote>

<p>First of all you can blur an image:</p>

<p><img class="thumbnail-right" src="/images/2016/03/blur_image.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{2}</span><span class="nt">&gt;</span>
  http://i.imgur.com/rkiglmm.jpg
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p><br /></p>

<p>But really anything can be passed-in here. For instance, a video</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{0.6}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;video</span> <span class="na">src=</span><span class="s">&quot;/video.mpg&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p>or a canvas:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{0.7}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="err">...</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p>and where that canvas can be provided by a library, like react-canvas:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{0.9}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ReactCanvas.Surface</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ReactCanvas.Text</span> <span class="err">...</span><span class="nt">&gt;</span>Hello World<span class="nt">&lt;/ReactCanvas.Text&gt;</span>
  <span class="nt">&lt;/ReactCanvas.Surface&gt;</span>
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p>In React Native context, we even have support for ANY view.
It can be a simple Text:</p>

<p><img class="thumbnail-right" src="/images/2016/03/text_blur.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{0.9}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Text</span> <span class="err">...</span><span class="nt">&gt;</span>Hello World<span class="nt">&lt;/Text&gt;</span>
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p><br /></p>

<p>or even a native component like a Switch component</p>

<p><img class="thumbnail-right" src="/images/2016/03/switch_blur.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{0.9}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Switch</span> <span class="err">...</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p><br /></p>

<p>The way this is implemented is platform specific. For instance the Web implementation will just render the content into WebGL (so it works with images, videos, canvas, but not any arbitrary DOM element due to Web Security limitations). However, the Native implementation will be able to <strong>rasterize</strong> (almost) any view and inject it as a texture (consider this feature experimental at the moment).</p>

<h2>Compose, Compose, Compose</h2>

<p>But <strong>composition</strong> is probably the MOST important part of this:
You can also pass a GL Component in uniforms!</p>

<p>So all possible composition of previous examples will just work</p>

<p><img class="thumbnail-right" src="/images/2016/03/diamond_hellogl.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;DiamondCrop&gt;</span>
  <span class="nt">&lt;HelloGL</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/DiamondCrop&gt;</span>
</code></pre></div>
<p><br /></p>

<p><img class="thumbnail-right" src="/images/2016/03/blur_diamond_hellogl.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Blur</span> <span class="na">factor=</span><span class="s">{4}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DiamondCrop&gt;</span>
    <span class="nt">&lt;HelloGL</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/DiamondCrop&gt;</span>
<span class="nt">&lt;/Blur&gt;</span>
</code></pre></div>
<p><br /></p>

<p><code>gl-react</code> makes composition efficient using OpenGL Framebuffers.
This approach encourages you to write small and generic shaders (instead of one monolithic and specific shader).</p>

<blockquote>
<p>For this composition to work correctly, the components must be created with <code>GL.createComponent</code> or directly be <code>GL.Node</code> components.</p>
</blockquote>

<h2>&lt;Surface/&gt;</h2>

<p>To actually get a rendering with gl-react, <strong>you need to put your GL Component stack into a &lt;Surface/&gt; element</strong>.</p>

<p>For instance, to render HelloGL on a 200x200 canvas:</p>

<p><img class="thumbnail-right" src="/images/2016/03/hellogl.png" /></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;Surface</span> <span class="na">width=</span><span class="s">{200}</span> <span class="na">height=</span><span class="s">{200}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;HelloGL</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Surface&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span><span class="nx">Surface</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;gl-react-dom&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">Surface</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;gl-react-native&quot;</span><span class="p">;</span>
</code></pre></div>
<p><br/></p>

<p><strong>Surface</strong> implements the rendering in the contextual platform:</p>

<ul>
<li>If you import <code>{Surface}</code> from <code>gl-react-dom</code> it will renders into a <strong>WebGL Canvas</strong> <strong><em>(web)</em></strong>, (it&#39;s backed by great <a href="http://stack.gl/">stack.gl</a> libs)</li>
<li>If, instead, it comes from <code>gl-react-native</code>, <strong>GLKView</strong> <strong><em>(iOS)</em></strong> / <strong>GLSurfaceView</strong> <strong><em>(Android)</em></strong> will be used.</li>
</ul>

<p><strong>Surface</strong> have roughly the same API across these 2 libraries but some props might exist only on one of the implementations.</p>

<h2>Dynamic Blur Image Title Example</h2>

<p>My talk featured an advanced use-case that we had in my startup, <a href="http://projectseptember.com/">Project September</a>. We are developing a social mobile app with React Native and our designer wanted to have title over image with Blur effects around the title text.</p>

<p><a href="http://greweb.me/reactjsconf2016/"><img src="/images/2016/03/hellosf.jpg" alt=""></a></p>

<p><a href="http://greweb.me/reactjsconf2016/">Open the demo</a> – <a href="https://github.com/gre/reactjsconf2016">See the code</a></p>

<p>This effect is just exposed as a simple <strong>ImageTitle</strong> React component that we can use like this:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;ImageTitle</span> <span class="na">text=</span><span class="s">&quot;Hello San Francisco ☻&quot;</span><span class="nt">&gt;</span>
  http://i.imgur.com/XXXXXX.jpg
<span class="nt">&lt;/ImageTitle&gt;</span>
</code></pre></div>
<p>The point of <code>gl-react</code> is we all know how to compose React components, just put it in a <strong>Surface</strong> and you obtain a title over image effect like on the image above.</p>

<blockquote>
<p>we can even run the effect over a video</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;ImageTitle</span> <span class="na">text=</span><span class="s">&quot;Hello San Francisco ☻&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;video</span> <span class="na">src=</span><span class="s">&quot;video.mp4&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/ImageTitle&gt;</span>
</code></pre></div>
<p>which is what <a href="http://greweb.me/reactjsconf2016/">our demo</a> does if you enable the video mode.</p>
</blockquote>

<h2>Under the hood</h2>

<blockquote>
<p>This section will show <strong>ImageTitle</strong> implementation that will illustrate <code>gl-react</code> optimization techniques.</p>
</blockquote>

<p>Let&#39;s take a quick look at our ImageTitle shader. That shader renders the title text on top of the blurred image. The title text color is chosen based on the average pixel color (if the content is dark, we use a white title, otherwise a black one).</p>

<p>I won&#39;t enter more into implementation detail, but here is the fragment shader:</p>

<p><img src="/images/2016/03/image-title-shader.png" alt=""></p>

<p>Now, let&#39;s focus on our JavaScript gl-react code.</p>

<p><strong>ImageTitle</strong> is a GL Component that takes a few props (basically <code>title</code> and <code>children</code>) and delegates the job using a few other Components: <strong>Title</strong> that renders the text, <strong>TitleBlurMap</strong> that generates a blur map of that text, <strong>BlurV</strong> that apply the blurmap to generate a variable blur over the content (image/video), <strong>AveragePixels</strong> that generate one pixel out of the content.
These 4 elements are then composed into our final ImageTitle shader.</p>

<p><img src="/images/2016/03/image-title-imports.png" alt="">
<img src="/images/2016/03/image-title-component.png" alt=""></p>

<p>Composition is the key point here, we have defined our component with simple code, delegated and composed part of the effect with other component.</p>

<p>And each sub-component is doing more work. For instance <strong>TitleBlurMap</strong> is itself another GL component, which uses composes a component <strong>Blur</strong> and apply a threshold to generate a black and white blur map:</p>

<p><img src="/images/2016/03/titleblurmap_impl.png" alt="">
<img src="/images/2016/03/titleblurmap_node_detail.png" alt=""></p>

<p>And so on! <strong>Blur</strong> is itself another GL component!
And like <strong>BlurV</strong>, it is implementing a 4-pass blur, so it will pipe 4 times a Blur1D component:</p>

<p><img src="/images/2016/03/blurstack.png" alt=""></p>

<p><strong>Blur</strong> simply recursively composes Blur1D:
<img src="/images/2016/03/blur_impl.png" alt=""></p>

<blockquote>
<p>Have I lost you? Don&#39;t worry, we will show in a few section what the big picture scene looks like.</p>
</blockquote>

<h3><a name="dedup"></a> How gl-react transform your Surface and effects stack</h3>

<p>We have just overviewed how deep a GL effects stack can be: going down into each individual component that itself use many other components can ends a with a pretty big tree. That&#39;s true for any React application actually, but React is still performant.</p>

<p><strong>However, we have a fundamental difference between classical React DOM and <code>gl-react</code>: a GL effects stack is just a single Canvas element at the end.</strong></p>

<blockquote>
<p>When you write a tree of GL Components, each component don&#39;t get append into the DOM like would do a stack of Virtual DOM elements. Instead we need at the end to render the full Virtual GL tree into one single <code>&lt;canvas/&gt;</code>.</p>
</blockquote>

<p>Therefore, we don&#39;t treat GL Component the same way React does. <code>gl-react</code> will do internal work to <strong>unfold user&#39;s Virtual GL tree</strong> and convert it into a <strong>&quot;scene&quot; object that contains everything a renderer need to know</strong>. This object is passed as a <code>&quot;data&quot;</code> props to the underlying implementation (that we call internally <strong><em>GLCanvas</em></strong>).</p>

<p>If we inspect with React Dev Tools what our <code>&lt;Surface/&gt;</code> actually gets render into you will see something like this:</p>

<p><img src="/images/2016/03/resolved_rendering.png" alt=""></p>

<p>Actually, the <code>Surface</code> get rendered into a... <code>&lt;div/&gt;</code> <strong>(1)</strong>. We need to do this because we need to not only render the Canvas <strong>(3)</strong> but we also need to render any possible content that was passed-in the stack that would need to get rasterized (in web context, it can be a <strong>video</strong> or another <strong>canvas</strong>). In our case, it&#39;s the <code>&lt;Title/&gt;</code> component, that is backed with <strong>react-canvas</strong> to draw Text using a Canvas (the only simple way to get texts in WebGL). So this is why we need <strong>(2)</strong>, that is a container for the content, that container is moved behind the canvas and is made invisible (unless you enable some hidden secret props! <a href="https://projectseptemberinc.gitbooks.io/gl-react/content/docs/api/Surface.html">read more about advanced props of Surface in the documentation</a>).</p>

<h3>How gl-react optimizes the effects stack &amp; factorize computation</h3>

<p>The previous complex example, if implemented naïvely, ends up with this big tree:</p>

<p><strong>1. Before factorization optimization:</strong> <em>(naïve implementation)</em>
<img src="/images/2016/03/reactjs2016_greweb.036.jpeg" alt=""></p>

<p>It contains a lot of duplicates: the Title rendering appears 6 times
and the &quot;Text Blurring 4-Blur stack&quot; also appears 5 times.</p>

<p>This is just computing the same thing multiple times where we should be able to compute it once...</p>

<p>To solve this, we will just use the VDOM <strong>referential transparency</strong>: if 2 VDOM element have the same reference, we can assume it renders the same thing so we can just dedupe to share and render it once.</p>

<blockquote>
<p>This is one of our biggest innovation in <code>gl-react</code>: when you give a stack of effects in Surface, we will dedupe the tree.</p>
</blockquote>

<p>At the end of this process our example results of:</p>

<p><strong>2. After factorization optimization:</strong>
<img src="/images/2016/03/reactjs2016_greweb.041.jpeg" alt=""></p>

<p>We have moved from 38 to 13 nodes and reduce the render speed from 20ms to 4ms.</p>

<h3>Conclusion</h3>

<p>If you would implement a stack of effects using the imperative OpenGL API, you would obviously write an ordered sequence of effects to do and that would naturally share the computations in temporary buffers for best performance.</p>

<p><strong>The important job of gl-react is to allow you to write descriptive code without losing this advantage of using temporary pixel buffers and keeping a thin layer on top of the underlying OpenGL.</strong></p>

<h2>Other side projects</h2>

<h3>gl-react-inspector</h3>

<p>One of the most appreciated part in my talk is the Inspector we specially develop for gl-react.</p>

<p>I initially developed it because I wanted to have charts to show people what gl-react graph looks like and without having to go Inkscape and handcrafting them...
But it ended up behind a useful tool to actually develop with, because you can see what&#39;s going on underneath (at each node step, and what the texture looks at intermediary steps). It also helps seeing investigating on performance.</p>

<p>Our big future challenge with this is to make it work as a standalone devtools (I imagine it could be part of the React devtools, if we could have plugins there).
and to make it work with React Native too.</p>

<h3>gl-react-dom-static-container</h3>

<p><a href="https://github.com/gre/gl-react-dom-static-container">https://github.com/gre/gl-react-dom-static-container</a></p>

<h3>Some universal GL effects</h3>

<ul>
<li><a href="https://github.com/gre/gl-react-blur">gl-react-blur</a></li>
<li><a href="https://github.com/gre/gl-react-negative">gl-react-negative</a></li>
<li><a href="https://github.com/gre/gl-react-constrast-saturation-brightness">gl-react-constrast-saturation-brightness</a></li>
<li><a href="https://github.com/gre/gl-react-hue-rotate">gl-react-hue-rotate</a></li>
<li><a href="https://github.com/gre/gl-react-color-matrix">gl-react-color-matrix</a></li>
</ul>

<h3>gl-react-image</h3>

<p><a href="https://github.com/gre/gl-react-image">gl-react-image</a> is a component that solves preserving ratios of your images (because stretching is the default behavior).</p>

<h2>We need your help!</h2>

<h3>What should come soon</h3>

<ul>
<li>caching framebuffers from one frame to another: allow different interesting things: cache part of the graph (e.g to allow to cache a static intensive part of the graph), cache part of a rendering with <code>discard;</code> (e.g if you make a Paint like) or even more crazy things like being able to inject the previous buffer as a texture to implement things like motion-blur or even <a href="http://mathworld.wolfram.com/CellularAutomaton.html">cellular automata</a>.</li>
</ul>

<h3>What might come after this</h3>

<ul>
<li>react-native-video / react-native-camera</li>
<li>static vertex data as well as static vertex shader is a current and decided (? chosen) limitation of <code>gl-react</code>. We want to focus on the incredible capabilities of fragment shaders and work on all optimization that can be made to improve the performance of working with this subset of OpenGL.</li>
</ul>

<h3>Other features</h3>

<p>This library begin the journey of bringing OpenGL to most people using the React simplicity, hiding some complex parts of OpenGL but allowing to implement the fundamental functional bricks of it.</p>

<p>There are a bunch of other features that would take me weeks to explain, but feel free to <a href="https://projectseptemberinc.gitbooks.io/gl-react/content/">read the documentation to learn more about the other props and features</a>.</p>

  </div>
  <footer class="comments">
    <div id="disqus_thread"></div>
  </footer>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'greweb'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    
</article>

      </div>

      <aside id="sidebar">
        <section class="latest_posts">
          <h3>Last Posts</h3>
          <ul>
            
            <li>
              <a href="/2016/12/gl-react-v3/">gl-react v3</a>
            </li>
            
            <li>
              <a href="/2016/09/relay-scrolling-connections/">Relay, scrolling connections</a>
            </li>
            
            <li>
              <a href="/2016/07/projectseptember-opengl/">🎉 There are some OpenGL in the Project September fashion app!</a>
            </li>
            
            <li>
              <a href="/2016/06/glreactconf/">Universal GL Effects for Web and Native</a>
            </li>
            
            <li>
              <a href="/2015/10/introducing-gl-react/">Introducing gl-react</a>
            </li>
            
            <li>
              <a href="/2015/08/making-performant-react-applications/">Making performant React applications</a>
            </li>
            
            <li>
              <a href="/2014/10/webglparis/">[FR] webglparis talk: GLSL.io initiative and WebGL Transitions</a>
            </li>
            
            <li>
              <a href="/2014/09/ibex-cellular-automata/">Cellular Automata in IBEX</a>
            </li>
            
            <li>
              <a href="/2014/09/ibex/">IBEX, my js13k game</a>
            </li>
            
            <li>
              <a href="/2014/05/ld29/">48 hours to prototype an Ant Sim Game</a>
            </li>
            
          </ul>
        </section>

        <section class="about_me">
          <h3>About the author</h3>
          <p>My name is Gaëtan Renaudeau (<a href="https://twitter.com/greweb">@greweb</a>)</p>
          <img style="float:left;margin-right:10px;margin-top:5px;width:80px" src="/images/avatar.jpg" alt="" />
          <p>
            I work at <a href="http://projectseptember.com/">ProjectSeptember</a>
            where I've developed <a href="https://github.com/ProjectSeptemberInc/gl-react">gl-react</a>.
            I enjoy hacking technology, experimenting with HTML5 techs like WebGL and WebAudio.
            I develop HTML5 games for fun, usually in <a href="http://ludumdare.com/compo/author/gre/">ludumdare game jam</a>.
          </p>
          <p>I speak French, English and learn Chinese.</p>
        </section>

        <section class="twitter">
          <h3>Last Tweets</h3>
          <a class="twitter-timeline" href="https://twitter.com/greweb" data-widget-id="325600219960057857"></a>
        </section>

        <section class="lichess">
          <h3>lichess TV</h3>
          <script src="http://en.lichess.org/tv/embed?theme=brown&bg=light"></script>
        </section>
      </aside>
    </div>
    </div>

    <footer role="contentinfo">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Licence Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png"></a>
      <span>Gaëtan Renaudeau</span>
      <a href="https://twitter.com/greweb" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @greweb</a>
    </footer>

<script type='text/javascript' src='/javascripts/header.js'></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'greweb'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script type="text/javascript">//<![CDATA[
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-9919624-1']);
_gaq.push(['_trackPageview']);
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
//]]></script>
  </body>
</html>
